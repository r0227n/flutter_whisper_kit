name: Pana Package Evaluation

on:
  workflow_call:
    inputs:
      package_dir:
        description: "Directory of the package to evaluate"
        required: true
        type: string
  pull_request:
    branches: ["release/**"]
  workflow_dispatch:
    inputs:
      package_dir:
        description: "Directory of the package to evaluate"
        required: true
        type: string
        default: "packages/flutter_whisper_kit"

jobs:
  pana-evaluation:
    name: Evaluate Package with Pana
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    env:
      BASE_DIR: /tmp/pana-evaluation
      PANA_OUTPUT_FILE: /tmp/pana-evaluation/pana_output.json
      COMMENT_FILE: /tmp/pana-evaluation/comment.md
      PACKAGE_DIR: ${{ inputs.package_dir }}
      PACKAGE_NAME: ${{ inputs.package_dir == 'packages/flutter_whisper_kit_apple' && 'Flutter Whisper Kit Apple' || 'Flutter Whisper Kit' }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: ./.github/actions/setup-flutter

      - name: Install Dependencies
        run: flutter pub get

      - name: Activate Pana
        run: dart pub global activate pana

      - name: Create Output Directory
        run: mkdir -p ${{ env.BASE_DIR }}

      - name: Run Pana Evaluation
        id: pana
        run: |
          # Run pana on the package directory
          cd ${{ env.PACKAGE_DIR }}
          dart pub global run pana --json --no-warning > ${{ env.PANA_OUTPUT_FILE }}

          # Extract key metrics from the output
          SCORE=$(cat ${{ env.PANA_OUTPUT_FILE }} | jq -r '.scores.grantedPoints')
          MAX_SCORE=$(cat ${{ env.PANA_OUTPUT_FILE }} | jq -r '.scores.maxPoints')
          PERCENTAGE=$(cat ${{ env.PANA_OUTPUT_FILE }} | jq -r '.scores.grantedPoints / .scores.maxPoints * 100 | floor')

          # Count issues by type
          ERRORS=$(cat ${{ env.PANA_OUTPUT_FILE }} | jq -r '[.report.sections[] | select(.status == "failed")] | length')
          WARNINGS=$(cat ${{ env.PANA_OUTPUT_FILE }} | jq -r '[.report.sections[] | select(.status == "partial")] | length')
          SUGGESTIONS=$(cat ${{ env.PANA_OUTPUT_FILE }} | jq -r '[.report.sections[] | .hints | length] | add // 0')

          # Save metrics to GITHUB_OUTPUT for the next step
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "max_score=$MAX_SCORE" >> $GITHUB_OUTPUT
          echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "suggestions=$SUGGESTIONS" >> $GITHUB_OUTPUT

      - name: Generate Comment Content
        id: comment
        if: github.event_name == 'pull_request'
        run: |
          # Read pana output
          PANA_OUTPUT=$(cat ${{ env.PANA_OUTPUT_FILE }})

          # Start building the comment
          echo "## ðŸ“Š Pana Package Evaluation Results: ${{ env.PACKAGE_NAME }}" > ${{ env.COMMENT_FILE }}
          echo "" >> ${{ env.COMMENT_FILE }}
          echo "### Overall Score: ${{ steps.pana.outputs.score }}/${{ steps.pana.outputs.max_score }} (${{ steps.pana.outputs.percentage }}%)" >> ${{ env.COMMENT_FILE }}
          echo "" >> ${{ env.COMMENT_FILE }}

          # Add summary of issues
          echo "### Summary" >> ${{ env.COMMENT_FILE }}
          echo "- ðŸ”´ Errors: ${{ steps.pana.outputs.errors || 0 }}" >> ${{ env.COMMENT_FILE }}
          echo "- ðŸŸ  Warnings: ${{ steps.pana.outputs.warnings || 0 }}" >> ${{ env.COMMENT_FILE }}
          echo "- ðŸ’¡ Suggestions: ${{ steps.pana.outputs.suggestions || 0 }}" >> ${{ env.COMMENT_FILE }}
          echo "" >> ${{ env.COMMENT_FILE }}

          # Add detailed report sections
          echo "### Detailed Report" >> ${{ env.COMMENT_FILE }}
          echo "" >> ${{ env.COMMENT_FILE }}

          # Process each section using jq
          jq -r '.report.sections[] | "#### " + 
            (if .status == "passed" then "âœ… " 
            elif .status == "failed" then "âŒ " 
            elif .status == "partial" then "âš ï¸ " 
            else "â“ " end) + 
            .title + 
            if (.hints | length > 0) then "\n<details><summary>Show details</summary>\n\n" + 
              (.hints | map("- " + .) | join("\n")) + 
              "\n\n</details>\n\n" 
            else "\n\n" end' ${{ env.PANA_OUTPUT_FILE }} >> ${{ env.COMMENT_FILE }}

          echo "" >> ${{ env.COMMENT_FILE }}
          echo "---" >> ${{ env.COMMENT_FILE }}
          echo "*This comment was automatically generated by the Pana Package Evaluation workflow.*" >> ${{ env.COMMENT_FILE }}

      - name: Post PR Comment
        if: github.event_name == 'pull_request'
        run: |
          # Post the comment to the PR using gh CLI
          gh pr comment ${{ github.event.pull_request.number }} --body-file ${{ env.COMMENT_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
